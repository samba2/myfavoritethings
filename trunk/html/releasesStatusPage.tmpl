<div id=releaseStatusPage>

<TMPL_IF NAME=RELEASENAMELOOP>
<p>

<form id='releaseSelectionForm' action="<TMPL_VAR NAME=SCRIPTNAME>">
    <select name="releaseId">
        <option value="">Select a release</option>
        <option value="">-----------------------------------</option>
        <TMPL_LOOP NAME="RELEASENAMELOOP">
	      <option value="<TMPL_VAR NAME="RELEASEIDHASH">" ><TMPL_VAR NAME="RELEASENAME"></option>
         </TMPL_LOOP>    
    </select>
</form>
</p>
<TMPL_ELSE>
<p>
No releases found in the database.
</p>
</TMPL_IF>

<TMPL_IF NAME=RELEASEID>
    <hr />
    <p><h4>Release "<TMPL_VAR NAME=RELEASENAME>"</h4></p>
    <p>
        <table>
        	<tr><td>Release name:</td><td><TMPL_VAR NAME=RELEASENAME></td></tr>
        	<tr><td>Release ID:</td><td><TMPL_VAR NAME=RELEASEID></td></tr>
            <tr><td>Status</td><td id='releaseStatus'><TMPL_VAR NAME=STATUS></td></tr>
        	<tr><td>Codes used:</td><td><TMPL_VAR NAME=USEDCODES> of <TMPL_VAR NAME=TOTALCODES></td></tr>
        
        	<TMPL_IF NAME="UPLOADFILESIZE">
        	    <tr><td>Size of uploaded file:</td><td><TMPL_VAR NAME=UPLOADFILESIZE>Bytes</td></tr>
        	<TMPL_ELSE>
        		<tr><td>File hasn't been uploaded</td>
        		    <td>
        			    <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=modifyFile&releaseId=<TMPL_VAR NAME=RELEASEID>">
        				    Upload here
        			    </a>
        		    </td>
        		</tr>	
            </TMPL_IF>
        </table>
    </p>
    <hr />
    <p>
        <a id="showDetails" href="#">Show details</a>
        &nbsp; | &nbsp;
        <TMPL_IF NAME="UPLOADFILEPATH">	
        	<a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=modifyFile&releaseId=<TMPL_VAR NAME=RELEASEID>">
        		Replace Uploaded File
        	</a>
        <TMPL_ELSE>
            <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=modifyFile&releaseId=<TMPL_VAR NAME=RELEASEID>">
                Add File
            </a>
        </TMPL_IF>
        &nbsp; | &nbsp;
        <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=exportToPdf&releaseId=<TMPL_VAR NAME=RELEASEID>">Export Download-Vouchers</a>
        &nbsp; | &nbsp;
        <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=exportToCsv&releaseId=<TMPL_VAR NAME=RELEASEID>">Export CSV-File</a>
        &nbsp; | &nbsp; 
        <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=checkCodeStatus&releaseId=<TMPL_VAR NAME=RELEASEID>">Check Code Status</a>
        &nbsp; | &nbsp;
        <a href="<TMPL_VAR NAME=SCRIPTNAME>?rm=deleteRelease&releaseId=<TMPL_VAR NAME=RELEASEID>">Delete Release</a>
        &nbsp; | &nbsp;
        <!-- Link for release status change -->
        <a id="changeReleaseStatus" href="#">Change Release Status</a>

    </p>
</TMPL_IF>

<!------- Show Details Button Data -------------->
<div id="dialogExtraInformation" title="Release Details">
    <p><h4>Paths</h4></p>
    <p>
    <table>
        <tr><td>Public download URL (forwarder): </td><td> <TMPL_VAR NAME=DOWNLOADURL></td></tr>
    
        <TMPL_IF NAME="UPLOADFILEPATH">
            <tr><td>Path to uploaded archive file: </td><td> <TMPL_VAR NAME=UPLOADFILEPATH></td></tr>
        </TMPL_IF>
        
        <tr><td>Path to database file containing <br> the download codes: </td><td> <TMPL_VAR NAME=RELEASEDBPATH></td></tr>
        <tr><td>Path to actual download program: &nbsp;  </td><td> <TMPL_VAR NAME=RELEASECGIURL></td></tr>
    </table>
    </p>
</div>
</div>

<div id="dialogChangeReleaseStatus" title="Change Release Status">
   <form id="formChangeReleaseStatus" action="<TMPL_VAR NAME=SCRIPTNAME>">
       
       <!-- different user questions depending on status -->
       <p id='paraSetOffline'>When shall this release become unavailable for public access?</p>
       <p id='paraSetOnline'>Do you want to set the release "<TMPL_VAR NAME=RELEASENAME>" online?</p>
       <p id='paraNoChangeFileMissing'>To change the status of release "<TMPL_VAR NAME=RELEASENAME>" you have to upload a file first.</p>
       <p id='paraRemoveExpiry'>Remove the expiry date of the release?</p>
       
       <div style="text-align:center;">
          <div id='divInputsSetOffline'>
               <p>
                   <input type="radio" name="offlineFrom" value="now" id="radioSetOfflineNow" /> Now
                   <input type="radio" name="offlineFrom" value="date" id="radioSetOfflineLater" /> In the future
               </p>
               <div id="divDatePicker">
                   <p>Date: <input type="text" style="width: 70px" id="txtDatePicker" /></p>
               </div>
           </div>
           <p><button id="buttonOK">OK</button></p> 
           <input type="hidden" name="rm" value="changeStatus" />
           <input type="hidden" name="releaseId" value="<TMPL_VAR NAME=RELEASEID>" />
       </div>
   </form>
</div>


 <script>
 $(document).ready(function(){
     
    // hide dialog divs
 	$('#dialogExtraInformation').hide();
    $('#dialogChangeReleaseStatus').hide();
	
    // open release on select
    $('#releaseSelectionForm').change(function(){
        if ($('#releaseSelectionForm :selected').val()) {
            $(this).submit();
        }
    }); 

    // handle changing release status
    $('#changeReleaseStatus').click(function () {
        //prepare
        hideElements();
        setupReleaseStatusButton();
        // display button
        $( "#dialogChangeReleaseStatus" ).dialog({ minHeight: 100 });
        
        // click functions
        $('#radioSetOfflineNow').click(function () {
            // reset datePicker if selected before
            $('#divDatePicker').hide("normal");
            $('#txtDatePicker').val("");
            $('#buttonOK').removeAttr('disabled');  
         });
         
        $('#radioSetOfflineLater').click(function () {
            // reset "Save" to disabled if coming from "radioSetOfflineNow"
            $('#buttonOK').attr('disabled', true);
            $('#divDatePicker').show("normal");
            $('#txtDatePicker').datepicker({
                minDate: 0,
                onSelect: function() { 
                    enableOKButton();
                }
            });
        });
        
        $('#buttonOK').click(function () {
            var date = "";
            
            if ($('#radioSetOfflineLater')) {
                // set posted value of radio button value to
                // eg 01242011
                date = $('#txtDatePicker').val();
                date = date.replace(/\//g,"");
                $('#radioSetOfflineLater').val(date);
            }
        });

        // helper functions
        function hideElements () {
            $('#buttonOK').attr('disabled', true);
            $('#divDatePicker').hide();
            $('#paraSetOffline').hide();
            $('#paraNoChangeFileMissing').hide();
            $('#paraSetOnline').hide();
            $('#paraRemoveExpiry').hide();
            $('#divInputsSetOffline').hide();
        }

        function setupReleaseStatusButton() {
            var status = $('#releaseStatus').text();
            
            if ( status === "Online" ) {
                $('#paraSetOffline').show();
                $('#divInputsSetOffline').show();
            }
            else if ( status === "Offline" || status === "Expired" ) {
                $('#paraSetOnline').show();
                enableOKButton();
            }
            else if ( statusIsExpiryDate(status) ) {
                $('#paraRemoveExpiry').show(); 
                enableOKButton();   
            }
            else if ( status === "File missing" ) {
                 $('#paraNoChangeFileMissing').show();
                 $('#buttonOK').hide();
            }
        }

        function statusIsExpiryDate(status) {
            if ( status.indexOf("Expires at") != -1 ) {
                return true;
            }
            return false;
        }
        
        function enableOKButton() {
            $('#buttonOK').removeAttr('disabled');
        }
        
    })

    // details button
    $('#showDetails').click(function () {
        $( "#dialogExtraInformation" ).dialog({ width: 600 });
    })

 })
 </script>